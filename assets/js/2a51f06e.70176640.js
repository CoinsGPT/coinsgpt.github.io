"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["92802"],{57234:function(n,t,e){e.d(t,{Z:()=>s});let s=e.p+"assets/images/bitcoin_data_pipeline-083bc34cccd93411924337896b88770f.png"},4023:function(n,t,e){e.r(t),e.d(t,{frontMatter:()=>a,default:()=>h,contentTitle:()=>d,assets:()=>c,toc:()=>l,metadata:()=>s});var s=JSON.parse('{"id":"bitcoin/clickhouse-schema","title":"04 ClickHouse Schema","description":"\\"Create Fat First, Then Make Tight\\" Strategy","source":"@site/docs/bitcoin/clickhouse-schema.md","sourceDirName":"bitcoin","slug":"/bitcoin/clickhouse-schema","permalink":"/docs/next/bitcoin/clickhouse-schema","draft":false,"unlisted":false,"editUrl":"https://github.com/coinsgpt/coinsgpt.github.io/edit/main/website/docs/bitcoin/clickhouse-schema.md","tags":[],"version":"current","lastUpdatedBy":"thebestornothing","lastUpdatedAt":1750597765000,"frontMatter":{},"sidebar":"bitcoin","previous":{"title":"04 ClickHouse Setup","permalink":"/docs/next/bitcoin/clickhouse-setup"},"next":{"title":"05 ClickHouse Schema Evolution","permalink":"/docs/next/bitcoin/clickhouse-schema-evolution"}}'),i=e(85893),r=e(80980);let a={},d="04 ClickHouse Schema",c={},l=[{value:"Fat \u279D Tight in Practice",id:"fat--tight-in-practice",level:2},{value:"Enhance &quot;fat \u279D tight&quot; model",id:"enhance-fat--tight-model",level:2},{value:"Block Design",id:"block-design",level:2},{value:"Transaction Design",id:"transaction-design",level:2},{value:"JSON type",id:"json-type",level:2},{value:"blocks.json",id:"blocksjson",level:3},{value:"transactions.json",id:"transactionsjson",level:3},{value:"transaction_input",id:"transaction_input",level:3},{value:"transaction_output",id:"transaction_output",level:3}];function o(n){let t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"04-clickhouse-schema",children:"04 ClickHouse Schema"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:e(57234).Z+"",width:"1536",height:"1024"})}),"\n",(0,i.jsx)(t.p,{children:'"Create Fat First, Then Make Tight" Strategy'}),"\n",(0,i.jsxs)(t.p,{children:["This design pattern\u2014",(0,i.jsx)(t.strong,{children:'"create fat, then make tight"'}),"\u2014is a ",(0,i.jsx)(t.strong,{children:"staging + optimization approach"})," for database schema design and data modeling. It's useful when:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"You're importing raw, nested, or complex data (e.g. from JSON, APIs, blockchain)"}),"\n",(0,i.jsx)(t.li,{children:"You want fast ingestion first, and optimized queries later"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"fat--tight-in-practice",children:"Fat \u279D Tight in Practice"}),"\n",(0,i.jsxs)(t.p,{children:["Step 1: ",(0,i.jsx)(t.strong,{children:"Create Fat Table (Staging Table)"})]}),"\n",(0,i.jsxs)(t.p,{children:["Start by creating a ",(0,i.jsx)(t.strong,{children:"fat schema"})," that mirrors your input data structure with nested arrays or wide fields."]}),"\n",(0,i.jsx)(t.p,{children:"Example (ClickHouse \u2013 Bitcoin Transactions):"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE transactions_fat (\n  txid String,\n  block_hash String,\n  inputs Array(Tuple(\n    index UInt64,\n    prev_txid String,\n    prev_vout UInt64,\n    script_sig String,\n    sequence UInt64,\n    value Float64,\n    addresses Array(String)\n  )),\n  outputs Array(Tuple(\n    index UInt64,\n    script_pubkey String,\n    value Float64,\n    addresses Array(String)\n  )),\n  block_time DateTime\n) ENGINE = MergeTree()\nORDER BY (block_time);\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Step 2: ",(0,i.jsx)(t.strong,{children:"Extract & Normalize into Tight Tables"})]}),"\n",(0,i.jsxs)(t.p,{children:["After the data is loaded, ",(0,i.jsx)(t.strong,{children:"flatten and normalize"}),' into "tight" tables:']}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Store one row per input/output/transaction"}),"\n",(0,i.jsx)(t.li,{children:"Extract key fields"}),"\n",(0,i.jsx)(t.li,{children:"Optimize for analytic queries"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Example: Inputs Table"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE tx_inputs (\n  txid String,\n  index UInt64,\n  prev_txid String,\n  prev_vout UInt64,\n  script_sig String,\n  sequence UInt64,\n  value Float64,\n  address String,\n  block_time DateTime\n) ENGINE = MergeTree()\nORDER BY (block_time);\n"})}),"\n",(0,i.jsx)(t.p,{children:"Transform from fat \u279D tight"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO tx_inputs\nSELECT\n  txid,\n  i.index,\n  i.prev_txid,\n  i.prev_vout,\n  i.script_sig,\n  i.sequence,\n  i.value,\n  addr AS address,\n  block_time\nFROM transactions_fat\nARRAY JOIN inputs AS i\nARRAY JOIN i.addresses AS addr;\n"})}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"This flattens nested arrays and creates a fast, queryable structure."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Why This Pattern Works"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Step"}),(0,i.jsx)(t.th,{children:"Goal"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.strong,{children:"Fat table"})}),(0,i.jsx)(t.td,{children:"Fast bulk insert, raw data integrity"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.strong,{children:"Tight table"})}),(0,i.jsx)(t.td,{children:"Optimized query performance, indexed structure"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.strong,{children:"Split later"})}),(0,i.jsx)(t.td,{children:"Post-ingestion transformation lets you adapt based on real usage"})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"Optional Enhancements"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.strong,{children:"materialized views"})," to automate tight-table generation"]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.strong,{children:"Kafka + ClickHouse"})," with JSON ingestion for real-time fat \u279D tight"]}),"\n",(0,i.jsxs)(t.li,{children:["Add ",(0,i.jsx)(t.strong,{children:"partitions"})," by block height or time in tight tables"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"enhance-fat--tight-model",children:'Enhance "fat \u279D tight" model'}),"\n",(0,i.jsxs)(t.p,{children:['Let\u2019s enhance the "fat \u279D tight" model using ',(0,i.jsx)(t.strong,{children:"Materialized Views in ClickHouse"}),", so that ",(0,i.jsx)(t.strong,{children:"flattened \u201Ctight\u201D tables are auto-populated"})," from the fat raw data."]}),"\n",(0,i.jsxs)(t.p,{children:["We have a ",(0,i.jsx)(t.strong,{children:"fat table"})," storing Bitcoin transactions with nested arrays for inputs/outputs."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Fast ingestion"})," into the fat table (from JSON, Kafka, etc.)"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Auto-generated tight tables"})," (e.g., ",(0,i.jsx)(t.code,{children:"tx_inputs"}),") for querying, updated in real-time"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Step-by-Step: Fat \u279D Tight via Materialized View"}),"\n",(0,i.jsx)(t.p,{children:"step 1. Fat Table (Staging)"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE transactions_fat (\n  txid String,\n  block_hash String,\n  inputs Array(Tuple(\n    index UInt64,\n    prev_txid String,\n    prev_vout UInt64,\n    script_sig String,\n    sequence UInt64,\n    value Float64,\n    addresses Array(String)\n  )),\n  outputs Array(Tuple(\n    index UInt64,\n    script_pubkey String,\n    value Float64,\n    addresses Array(String)\n  )),\n  block_time DateTime\n) ENGINE = MergeTree()\nORDER BY (block_time);\n"})}),"\n",(0,i.jsx)(t.p,{children:"setp 2. Tight Table for Inputs"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE tx_inputs (\n  txid String,\n  index UInt64,\n  prev_txid String,\n  prev_vout UInt64,\n  script_sig String,\n  sequence UInt64,\n  value Float64,\n  address String,\n  block_time DateTime\n) ENGINE = MergeTree()\nORDER BY (block_time);\n"})}),"\n",(0,i.jsx)(t.p,{children:"setp 3. Materialized View (Fat \u279D Inputs)"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE MATERIALIZED VIEW mv_tx_inputs\nTO tx_inputs AS\nSELECT\n  txid,\n  i.index,\n  i.prev_txid,\n  i.prev_vout,\n  i.script_sig,\n  i.sequence,\n  i.value,\n  addr AS address,\n  block_time\nFROM transactions_fat\nARRAY JOIN inputs AS i\nARRAY JOIN i.addresses AS addr;\n"})}),"\n",(0,i.jsx)(t.p,{children:"How It Works"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Every ",(0,i.jsx)(t.code,{children:"INSERT"})," into ",(0,i.jsx)(t.code,{children:"transactions_fat"})," ",(0,i.jsx)(t.strong,{children:"automatically triggers"})," ",(0,i.jsx)(t.code,{children:"mv_tx_inputs"})]}),"\n",(0,i.jsxs)(t.li,{children:["The view flattens nested inputs and inserts rows into ",(0,i.jsx)(t.code,{children:"tx_inputs"})]}),"\n",(0,i.jsx)(t.li,{children:"No need for separate transformation queries or batch jobs"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"block-design",children:"Block Design"}),"\n",(0,i.jsxs)(t.p,{children:["To ETL the raw data of block from (Bitcoin Core)[",(0,i.jsx)(t.a,{href:"https://bitcoincore.org/en/doc/29.0.0/rpc/blockchain/getblock/",children:"https://bitcoincore.org/en/doc/29.0.0/rpc/blockchain/getblock/"}),"] as blocks_fat."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE blocks_fat\n(\n  hash String,\n  size UInt64,\n  stripped_size UInt64,\n  weight UInt64,\n  number UInt64,\n  version UInt64,\n  merkle_root String,\n  timestamp DateTime,\n  timestamp_month Date,\n  nonce String,\n  bits String,\n  coinbase_param String,\n  previous_block_hash String,\n  difficulty Float64,\n  transaction_count UInt64,\n  transactions Array(String)\n)\nENGINE = ReplacingMergeTree()\nPRIMARY KEY (hash)\nPARTITION BY toYYYYMM(timestamp_month)\nORDER BY hash;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["To create a ",(0,i.jsxs)(t.strong,{children:["tight ",(0,i.jsx)(t.code,{children:"blocks"})," table"]})," without the ",(0,i.jsx)(t.code,{children:"transactions"})," array from your ",(0,i.jsx)(t.code,{children:"blocks_fat"})," table using a ",(0,i.jsx)(t.strong,{children:"Materialized View"}),", follow this plan:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Excluding the ",(0,i.jsx)(t.code,{children:"transactions"})," array"]}),"\n",(0,i.jsx)(t.li,{children:"Keeping all other atomic block attributes"}),"\n",(0,i.jsx)(t.li,{children:"Auto-populating the tight table on insert"}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE blocks\n(\n  hash String,\n  size UInt64,\n  stripped_size UInt64,\n  weight UInt64,\n  number UInt64,\n  version UInt64,\n  merkle_root String,\n  timestamp DateTime,\n  timestamp_month Date,\n  nonce String,\n  bits String,\n  coinbase_param String,\n  previous_block_hash String,\n  difficulty Float64,\n  transaction_count UInt64\n)\nENGINE = MergeTree()\nPARTITION BY toYYYYMM(timestamp_month)\nORDER BY hash;\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Create the Materialized View from ",(0,i.jsx)(t.code,{children:"blocks_fat"})," \u279D ",(0,i.jsx)(t.code,{children:"blocks"})]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE MATERIALIZED VIEW blocks_tight_mv\nTO blocks AS\nSELECT\n  hash,\n  size,\n  stripped_size,\n  weight,\n  number,\n  version,\n  merkle_root,\n  timestamp,\n  timestamp_month,\n  nonce,\n  bits,\n  coinbase_param,\n  previous_block_hash,\n  difficulty,\n  transaction_count\nFROM blocks_fat;\n"})}),"\n",(0,i.jsx)(t.p,{children:"Summary::w"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Component"}),(0,i.jsx)(t.th,{children:"Purpose"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"blocks_fat"})}),(0,i.jsx)(t.td,{children:"Full raw block data (with txs)"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"blocks"})}),(0,i.jsx)(t.td,{children:"Optimized analytic structure"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"mv_blocks_tight"})}),(0,i.jsx)(t.td,{children:"Materialized View (fat \u279D tight)"})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"transaction-design",children:"Transaction Design"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE transactions_fat\n(\n  hash String,\n  size UInt64,\n  virtual_size UInt64,\n  version UInt64,\n  lock_time UInt64,\n  block_hash String,\n  block_number UInt64,\n  block_timestamp DateTime,\n  block_timestamp_month Date,\n  is_coinbase BOOL,\n  input_count UInt64,\n  output_count UInt64,\n  input_value Float64,\n  output_value Float64,\n  fee Float64,\n  inputs Array(Tuple(index UInt64, spent_transaction_hash String, spent_output_index UInt64, script_asm String, script_hex String, sequence UInt64, required_signatures UInt64, type String, addresses Array(String), value Float64)),\n  outputs Array(Tuple(index UInt64, script_asm String, script_hex String, required_signatures UInt64, type String, addresses Array(String), value Float64))\n)\nENGINE = ReplacingMergeTree()\nPRIMARY KEY (hash)\nPARTITION BY toYYYYMM(block_timestamp_month)\nORDER BY (hash);\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE inputs\n(\n    transaction_hash String,\n    input_index UInt64,\n    block_hash String,\n    block_number UInt64,\n    block_timestamp DateTime,\n    spending_transaction_hash String,\n    spending_output_index UInt64,\n    script_asm String,\n    script_hex String,\n    sequence UInt64,\n    required_signatures UInt64,\n    type String,\n    addresses Array(String),\n    value Float64\n)\nENGINE = MergeTree()\nPARTITION BY toYYYYMM(block_timestamp)\nORDER BY (transaction_hash, input_index);\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE inputs\n(\n    transaction_hash String,\n    input_index UInt64,\n    block_hash String,\n    block_number UInt64,\n    block_timestamp DateTime,\n    spending_transaction_hash String,\n    spending_output_index UInt64,\n    script_asm String,\n    script_hex String,\n    sequence UInt64,\n    required_signatures UInt64,\n    type String,\n    addresses Array(String),\n    value Float64,\n    version DateTime\n)\nENGINE = MergeTree(version)\nPARTITION BY toYYYYMM(block_timestamp)\nORDER BY (transaction_hash, input_index);\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE outputs\n(\n    transaction_hash String,\n    output_index UInt64,\n    block_hash String,\n    block_number UInt64,\n    block_timestamp DateTime,\n    spent_transaction_hash String,\n    spent_input_index UInt64,\n    script_asm String,\n    script_hex String,\n    required_signatures UInt64,\n    type String,\n    addresses Array(String),\n    value Float64,\n    version DateTime\n)\nENGINE = ReplacingMergeTree(version)\nPARTITION BY toYYYYMM(block_timestamp)\nORDER BY (transaction_hash, output_index);\n\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE outputs\n(\n    transaction_hash String,\n    output_index UInt64,\n    block_hash String,\n    block_number UInt64,\n    block_timestamp DateTime,\n    spent_transaction_hash String,\n    spent_input_index UInt64,\n    spent_block_hash String,\n    spent_block_number UInt64,\n    spent_block_timestamp DateTime,\n    script_asm String,\n    script_hex String,\n    required_signatures UInt64,\n    type String,\n    addresses Array(String),\n    value Float64\n)\nENGINE = ReplacingMergeTree(spent_block_timestamp)\nPARTITION BY toYYYYMM(block_timestamp)\nORDER BY (transaction_hash, output_index);\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO inputs\nSELECT\n    hash AS transaction_hash,\n    input.1 AS input_index,\n    block_hash,\n    block_number,\n    block_timestamp,\n    input.2 AS spending_transaction_hash,\n    input.3 AS spending_output_index,\n    input.4 AS script_asm,\n    input.5 AS script_hex,\n    input.6 AS sequence,\n    input.7 AS required_signatures,\n    input.8 AS type,\n    input.9 AS addresses,\n    input.10 AS value\nFROM transactions_fat\nARRAY JOIN inputs AS input\nWHERE block_timestamp >= '2009-01-01' AND block_timestamp < '2012-09-01';\n\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO inputs\nSELECT\n    hash AS transaction_hash,\n    input.1 AS input_index,\n    block_hash,\n    block_number,\n    block_timestamp,\n    input.2 AS spending_transaction_hash,\n    input.3 AS spending_output_index,\n    input.4 AS script_asm,\n    input.5 AS script_hex,\n    input.6 AS sequence,\n    input.7 AS required_signatures,\n    input.8 AS type,\n    input.9 AS addresses,\n    input.10 AS value\n    block_timestamp as version\nFROM transactions_fat\nARRAY JOIN inputs AS input\nWHERE block_timestamp >= '2009-01-01' AND block_timestamp < '2012-09-01';\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO outputs\nSELECT\n    hash AS transaction_hash,\n    output.1 AS output_index,\n    block_hash,\n    block_number,\n    block_timestamp,\n    '' AS spent_transaction_hash,  -- initially empty\n    0 AS spent_input_index,        -- initially zero\n    output.2 AS script_asm,\n    output.3 AS script_hex,\n    output.4 AS required_signatures,\n    output.5 AS type,\n    output.6 AS addresses,\n    output.7 AS value,\n    block_timestamp as version\nFROM transactions_fat\nARRAY JOIN outputs AS output\nWHERE block_timestamp >= '2009-01-01' AND block_timestamp < '2012-09-01';\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO outputs\nSELECT\n    i.spending_transaction_hash AS transaction_hash,\n    i.spending_output_index     AS output_index,\n    o.block_hash,\n    o.block_number,\n    o.block_timestamp,\n    i.transaction_hash AS spent_transaction_hash,\n    i.input_index AS spent_input_index,\n    o.script_asm,\n    o.script_hex,\n    o.required_signatures,\n    o.type,\n    o.addresses,\n    o.value,\n    i.block_timestamp AS version  -- new version, replaces older\nFROM inputs AS i\nINNER JOIN outputs AS o\n    ON i.spending_transaction_hash = o.transaction_hash AND\n       i.spending_output_index = o.output_index\nWHERE (toYYYYMM(i.block_timestamp) >= 201001) AND (toYYYYMM(i.block_timestamp) < 201209);\n\n-- WHERE (toYYYYMM(i.block_timestamp) = 200901) ;\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"OPTIMIZE TABLE outputs FINAL;\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE TABLE address_flat\n(\n    transaction_hash String,\n    output_index UInt64,\n    block_hash String,\n    block_number UInt64,\n    block_timestamp DateTime,\n    address String,\n    value Float64,\n    spent_transaction_hash String,\n    spent_input_index UInt64,\n    version DateTime\n)\nENGINE = ReplacingMergeTree(version)\nPARTITION BY toYYYYMM(block_timestamp)\nORDER BY (address, transaction_hash, output_index);\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"INSERT INTO address_flat\nSELECT\n    o.transaction_hash,\n    o.output_index,\n    o.block_hash,\n    o.block_number,\n    o.block_timestamp,\n    address,\n    o.value,\n    o.spent_transaction_hash,\n    o.spent_input_index,\n    o.block_timestamp AS version\nFROM outputs AS o\nARRAY JOIN o.addresses AS address;\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"CREATE MATERIALIZED VIEW outputs_to_address_mv\nTO address_flat\nAS\nSELECT\n    o.transaction_hash,\n    o.output_index,\n    o.block_hash,\n    o.block_number,\n    o.block_timestamp,\n    address,\n    o.value,\n    o.spent_transaction_hash,\n    o.spent_input_index,\n    o.block_timestamp AS version\nFROM outputs AS o\nARRAY JOIN o.addresses AS address;\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"SELECT\n    sum(value) / 100000000.0 AS balance\nFROM address_flat FINAL\nWHERE address = '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa'\n  AND spent_transaction_hash = '';\n\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"from clickhouse_driver import Client\nfrom datetime import datetime\nfrom dateutil.relativedelta import relativedelta\n\n# === CONFIGURATION ===\nCLICKHOUSE_HOST = 'localhost'\nCLICKHOUSE_PORT = 9000\nCLICKHOUSE_USER = 'default'\nCLICKHOUSE_PASSWORD = 'password'\nDATABASE = 'bitcoin'\n\n# === INIT CLIENT ===\nclient = Client(\n    host=CLICKHOUSE_HOST,\n    port=CLICKHOUSE_PORT,\n    user=CLICKHOUSE_USER,\n    password=CLICKHOUSE_PASSWORD,\n    database=DATABASE,\n)\n\n\n#client = Client('localhost')  # configure host/user/password if needed\n\n# Choose the partition\npartition_start = datetime(2009, 1, 1)\npartition_end = partition_start + relativedelta(months=1)\nstart_str = partition_start.strftime('%Y-%m-%d')\nend_str = partition_end.strftime('%Y-%m-%d')\n\n# Step 1: Load all inputs in the target partition\ninputs = client.execute(f\"\"\"\nSELECT transaction_hash, input_index, spending_transaction_hash, spending_output_index\nFROM inputs\nWHERE block_timestamp >= toDateTime('{start_str}')\n  AND block_timestamp < toDateTime('{end_str}');\n\"\"\")\n\nprint(f\"Loaded {len(inputs)} inputs from partition {start_str} to {end_str}\")\n\n# Step 2: For each input, find and update the corresponding output\nfor row in inputs:\n    input_tx_hash, input_index, spending_tx_hash, spending_output_index = row\n\n    # Step 2.1: Find the output row that matches\n    matched_outputs = client.execute(f\"\"\"\n    SELECT transaction_hash, output_index\n    FROM outputs\n    WHERE transaction_hash = %(spending_tx_hash)s\n      AND output_index = %(spending_output_index)s\n    LIMIT 1;\n    \"\"\", {\n        'spending_tx_hash': spending_tx_hash,\n        'spending_output_index': spending_output_index\n    })\n\n    if matched_outputs:\n        # Step 3: Update the output row with spent info\n        client.execute(f\"\"\"\n        ALTER TABLE outputs\n        UPDATE\n            spent_transaction_hash = %(input_tx_hash)s,\n            spent_input_index = %(input_index)s\n        WHERE\n            transaction_hash = %(spending_tx_hash)s\n            AND output_index = %(spending_output_index)s;\n        \"\"\", {\n            'input_tx_hash': input_tx_hash,\n            'input_index': input_index,\n            'spending_tx_hash': spending_tx_hash,\n            'spending_output_index': spending_output_index\n        })\n\nprint(\"All relevant outputs updated.\")\n\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-sql",children:"select * from outputs where spent_transaction_hash != '' and block_timestamp < '2009-01-31'\n"})}),"\n",(0,i.jsx)(t.p,{children:"The ouput of the sql will be 123 same as {len(inputs)}"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python"})}),"\n",(0,i.jsx)(t.h2,{id:"json-type",children:"JSON type"}),"\n",(0,i.jsx)(t.h3,{id:"blocksjson",children:"blocks.json"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Field"}),(0,i.jsx)(t.th,{children:"Type"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"hash"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"size"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"stripped_size"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"weight"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"number"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"version"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"merkle_root"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"timestamp"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"nonce"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"bits"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"coinbase_param"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"transaction_count"}),(0,i.jsx)(t.td,{children:"bigint"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"transactionsjson",children:"transactions.json"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Field"}),(0,i.jsx)(t.th,{children:"Type"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"hash"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"size"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"virtual_size"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"version"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"lock_time"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"block_number"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"block_hash"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"block_timestamp"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"is_coinbase"}),(0,i.jsx)(t.td,{children:"boolean"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"index"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"inputs"}),(0,i.jsx)(t.td,{children:"[]transaction_input"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"outputs"}),(0,i.jsx)(t.td,{children:"[]transaction_output"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"input_count"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"output_count"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"input_value"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"output_value"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"fee"}),(0,i.jsx)(t.td,{children:"bigint"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"transaction_input",children:"transaction_input"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Field"}),(0,i.jsx)(t.th,{children:"Type"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"index"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"spent_transaction_hash"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"spent_output_index"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"script_asm"}),(0,i.jsx)(t.td,{children:"string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"script_hex"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"sequence"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"required_signatures"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"type"}),(0,i.jsx)(t.td,{children:"string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"addresses"}),(0,i.jsx)(t.td,{children:"[]string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"value"}),(0,i.jsx)(t.td,{children:"bigint"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"transaction_output",children:"transaction_output"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Field"}),(0,i.jsx)(t.th,{children:"Type"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"index"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"script_asm"}),(0,i.jsx)(t.td,{children:"string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"script_hex"}),(0,i.jsx)(t.td,{children:"hex_string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"required_signatures"}),(0,i.jsx)(t.td,{children:"bigint"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"type"}),(0,i.jsx)(t.td,{children:"string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"addresses"}),(0,i.jsx)(t.td,{children:"[]string"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"value"}),(0,i.jsx)(t.td,{children:"bigint"})]})]})]})]})}function h(n={}){let{wrapper:t}={...(0,r.a)(),...n.components};return t?(0,i.jsx)(t,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},80980:function(n,t,e){e.d(t,{Z:()=>d,a:()=>a});var s=e(67294);let i={},r=s.createContext(i);function a(n){let t=s.useContext(r);return s.useMemo(function(){return"function"==typeof n?n(t):{...t,...n}},[t,n])}function d(n){let t;return t=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:a(n.components),s.createElement(r.Provider,{value:t},n.children)}}}]);